{% extends 'base.html' %}
{% load static %}

{% block body %}
<div class="container py-5">
    <h3 class="mb-4 text-center text-warning" style="text-shadow: 2px 2px #062D76;">
        Gestión de Datos: Raimon Hub
    </h3>

    <div class="row">
        <div class="col-md-6 mb-4">
            <div class="card p-4 shadow-sm bg-dark text-white border-warning">
                <h5>Web Scraping Automático</h5>
                <p class="small text-secondary">Extrae personajes directamente de la Wiki de Inazuma Eleven.</p>
                <form method="post" action="{% url 'data_load' %}">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="scraping">
                    <button type="submit" class="btn btn-warning w-100">
                        ¡Llamar al equipo! (Scraping)
                    </button>
                </form>
            </div>
        </div>

        <div class="col-md-6 mb-4">
            <form id="csvForm" method="post" enctype="multipart/form-data" action="{% url 'data_load' %}" class="card p-4 shadow-sm h-100">
                {% csrf_token %}
                <input type="hidden" name="action" value="csv">

                <div class="mb-3">
                    <label for="csvFile" class="form-label font-weight-bold">Cargar Jugadores vía CSV</label>
                    <input class="form-control" type="file" id="csvFile" name="csvFile" accept=".csv" required>
                    <div class="form-text text-muted">Formato: Nombre, Posicion, Imagen</div>
                </div>

                <div class="d-flex justify-content-center gap-3 mt-auto">
                    <button type="button" id="previewBtn" class="btn btn-outline-primary">
                        <i class="fas fa-eye"></i> Previsualizar
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Guardar CSV
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="previewContainer" class="mt-5" style="display:none;">
        <div class="card bg-dark border-primary p-3">
            <h4 class="text-warning border-bottom border-warning pb-2">Vista previa del fichaje:</h4>
            <div class="table-responsive">
                <table class="table table-dark table-hover" id="previewTable">
                    <thead class="text-info"></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    // Lógica de previsualización (Mantenida y mejorada para evitar errores de celdas vacías)
    document.getElementById('previewBtn').addEventListener('click', function () {
        const fileInput = document.getElementById('csvFile');
        const file = fileInput.files[0];
        if (!file) {
            alert('Entrenador, primero selecciona un archivo CSV.');
            return;
        }

        const reader = new FileReader();
        reader.onload = function (e) {
            const text = e.target.result;
            const rows = text.split('\n').filter(row => row.trim() !== ""); // Evitamos filas vacías
            const tableHead = document.querySelector('#previewTable thead');
            const tableBody = document.querySelector('#previewTable tbody');
            tableHead.innerHTML = '';
            tableBody.innerHTML = '';

            if (rows.length > 0) {
                const headerRow = document.createElement('tr');
                rows[0].split(',').forEach(header => {
                    const th = document.createElement('th');
                    th.textContent = header.trim();
                    headerRow.appendChild(th);
                });
                tableHead.appendChild(headerRow);
            }

            // Mostramos máximo 5 filas para no saturar
            rows.slice(1, 6).forEach(row => {
                const tr = document.createElement('tr');
                row.split(',').forEach(cell => {
                    const td = document.createElement('td');
                    td.textContent = cell.trim();
                    tr.appendChild(td);
                });
                tableBody.appendChild(tr);
            });
            document.getElementById('previewContainer').style.display = 'block';
        };
        reader.readAsText(file);
    });
</script>
{% endblock %}